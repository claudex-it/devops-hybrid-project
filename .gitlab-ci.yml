stages:
  - build
  - deploy

variables:
  IMAGE_NAME: "devops-app"
  IMAGE_TAG: "${CI_COMMIT_SHORT_SHA}"

# ---------------------
# üèóÔ∏è BUILD STAGE
# ---------------------
build:
  stage: build
  tags: [local]
  script:
    - echo "‚û°Ô∏è Switching Docker to Minikube daemon..."
    - eval $(minikube docker-env)
    - echo "‚û°Ô∏è Building Docker image..."
    - docker build -t ${IMAGE_NAME}:${IMAGE_TAG} ./app
    - docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
    - echo "‚úÖ Docker image built successfully:"
    - docker images | grep ${IMAGE_NAME}

# ---------------------
# üöÄ DEPLOY STAGE
# ---------------------
deploy:
  stage: deploy
  tags: [local]
  needs: ["build"]
  script:
    - echo "‚û°Ô∏è Deploying application to Kubernetes..."
    - kubectl apply -f kubernetes/service.yaml
    - kubectl apply -f kubernetes/deployment.yaml
    - echo "‚û°Ô∏è Updating image to new build version..."
    - kubectl set image deployment/devops-app devops-app=${IMAGE_NAME}:${IMAGE_TAG} --record
    - kubectl rollout status deployment/devops-app
    - echo "‚úÖ Deployment successful!"
